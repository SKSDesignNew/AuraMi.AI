name: Build & Deploy to AWS

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  # ─────────────────────────────────────────────
  # Job 1: Lint & Type Check
  # ─────────────────────────────────────────────
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - name: TypeScript type check
        run: npx tsc --noEmit

      - name: ESLint
        run: npm run lint

  # ─────────────────────────────────────────────
  # Job 2: Build
  # ─────────────────────────────────────────────
  build:
    name: Build Next.js
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - name: Build
        run: npm run build
        env:
          # Provide dummy values so Next.js build doesn't fail on missing env vars
          DB_HOST: localhost
          DB_PORT: '5432'
          DB_NAME: aurami
          DB_USER: postgres
          DB_PASSWORD: placeholder
          NEXTAUTH_URL: https://aurami.ai
          NEXTAUTH_SECRET: build-time-placeholder
          ANTHROPIC_API_KEY: sk-ant-placeholder
          OPENAI_API_KEY: sk-placeholder
          AWS_ACCESS_KEY_ID: placeholder
          AWS_SECRET_ACCESS_KEY: placeholder
          S3_BUCKET: placeholder

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: |
            .next/
            !.next/cache/
          retention-days: 3

  # ─────────────────────────────────────────────
  # Job 3: Database Migration (on push to main/staging only)
  # ─────────────────────────────────────────────
  migrate:
    name: Run DB Migrations
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push'
    environment: ${{ github.ref_name == 'main' && 'production' || 'staging' }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - run: npm ci

      - name: Run database migrations
        run: node scripts/migrate.mjs
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_SSL: ${{ secrets.DB_SSL }}

  # ─────────────────────────────────────────────
  # Job 4: Deploy to AWS Amplify
  # ─────────────────────────────────────────────
  deploy:
    name: Deploy to AWS Amplify
    runs-on: ubuntu-latest
    needs: [build, migrate]
    if: github.event_name == 'push'
    environment:
      name: ${{ github.ref_name == 'main' && 'production' || 'staging' }}
      url: ${{ steps.amplify-deploy.outputs.app_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build
          path: .next/

      - name: Trigger Amplify deployment
        id: amplify-deploy
        run: |
          BRANCH="${{ github.ref_name }}"
          APP_ID="${{ secrets.AMPLIFY_APP_ID }}"

          echo "Triggering deployment for branch: $BRANCH"

          # Start the Amplify job
          JOB=$(aws amplify start-job \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH" \
            --job-type RELEASE \
            --query 'jobSummary.jobId' \
            --output text)

          echo "Amplify job started: $JOB"
          echo "job_id=$JOB" >> "$GITHUB_OUTPUT"

          # Poll for completion (max 10 minutes)
          for i in $(seq 1 60); do
            STATUS=$(aws amplify get-job \
              --app-id "$APP_ID" \
              --branch-name "$BRANCH" \
              --job-id "$JOB" \
              --query 'job.summary.status' \
              --output text)

            echo "Status: $STATUS (attempt $i/60)"

            if [ "$STATUS" = "SUCCEED" ]; then
              echo "Deployment succeeded!"

              # Get the app URL
              APP_URL=$(aws amplify get-branch \
                --app-id "$APP_ID" \
                --branch-name "$BRANCH" \
                --query 'branch.displayName' \
                --output text)
              echo "app_url=https://${BRANCH}.${APP_ID}.amplifyapp.com" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            if [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "CANCELLED" ]; then
              echo "Deployment failed with status: $STATUS"
              exit 1
            fi

            sleep 10
          done

          echo "Deployment timed out"
          exit 1

  # ─────────────────────────────────────────────
  # Job 5: Post-deploy health check
  # ─────────────────────────────────────────────
  healthcheck:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push'
    steps:
      - name: Wait for deployment to propagate
        run: sleep 30

      - name: Check app health
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            URL="${{ secrets.PRODUCTION_URL }}"
          else
            URL="${{ secrets.STAGING_URL }}"
          fi

          echo "Checking health at: $URL"

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL" --max-time 30)
          echo "HTTP Status: $STATUS"

          if [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 400 ]; then
            echo "Health check passed!"
          else
            echo "Health check failed with status: $STATUS"
            exit 1
          fi

  # ─────────────────────────────────────────────
  # Job 6: Notify on completion
  # ─────────────────────────────────────────────
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy, healthcheck]
    if: always() && github.event_name == 'push'
    steps:
      - name: Deployment summary
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ] && [ "${{ needs.healthcheck.result }}" = "success" ]; then
            echo "## Deployment Successful" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Branch:** ${{ github.ref_name }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Commit:** ${{ github.sha }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Author:** ${{ github.actor }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Status:** Deployed and healthy" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## Deployment Failed" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Branch:** ${{ github.ref_name }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Commit:** ${{ github.sha }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Deploy status:** ${{ needs.deploy.result }}" >> "$GITHUB_STEP_SUMMARY"
            echo "- **Health check:** ${{ needs.healthcheck.result }}" >> "$GITHUB_STEP_SUMMARY"
          fi
